<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Review Management Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Google Maps Places API script -->
    <script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBXdjRQZJd9ySH5mxql4tlXCEVpDH9GGbI&libraries=places&callback=initMaps"></script>
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #111827; }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #1f2937; }
        ::-webkit-scrollbar-thumb { background: #4b5563; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #6b7280; }
        .file-input-button, .view-button { cursor: pointer; }
        .review-item { transition: all 0.3s ease-in-out; }
        @keyframes fadeInOut {
            0%, 100% { opacity: 0; transform: translateY(20px); }
            10%, 90% { opacity: 1; transform: translateY(0); }
        }
        .notification-toast { animation: fadeInOut 4s ease-in-out forwards; }
        button:disabled, input:disabled, textarea:disabled { opacity: 0.5; cursor: not-allowed; }
        .pac-container { background-color: #1f2937; border: 1px solid #4b5563; border-radius: 0.5rem; color: #d1d5db; z-index: 10000 !important; }
        .pac-item { padding: 0.75rem; cursor: pointer; border-top: 1px solid #374151; }
        .pac-item:first-child { border-top: none; }
        .pac-item:hover { background-color: #374151; }
        .pac-item-query { font-weight: 500; color: #f9fafb; }
        .hidden { display: none; }
        .sticky-tabs { position: sticky; top: 0; z-index: 10; background-color: #111827; padding-top: 0.5rem; padding-bottom: 0.5rem; }
        #map { height: 350px; border-radius: 0.75rem; }
        .pac-target-input { padding: 0.75rem; width: 100%; }
    </style>
</head>
<body class="text-gray-200">

    <div id="app" class="container mx-auto max-w-7xl p-4 sm:p-6 lg:p-8">

        <!-- Initial View: Choose Portal -->
        <div id="initial-view">
            <header class="text-center mb-12">
                <h1 class="text-4xl sm:text-5xl font-bold text-white">Review Management Portal</h1>
                <p class="text-gray-400 mt-2">Please select your portal to continue.</p>
            </header>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-8 max-w-6xl mx-auto">
                <div id="client-portal-btn" class="view-button text-center p-8 bg-gray-800 rounded-xl border border-gray-700 hover:border-blue-500 hover:bg-gray-700 transition-all duration-300 transform hover:-translate-y-1">
                    <h2 class="text-3xl font-bold text-blue-400">Client Area</h2>
                    <p class="mt-2 text-gray-400">Submit new reviews for a business.</p>
                </div>
                <div id="owner-portal-btn" class="view-button text-center p-8 bg-gray-800 rounded-xl border border-gray-700 hover:border-teal-500 hover:bg-gray-700 transition-all duration-300 transform hover:-translate-y-1">
                    <h2 class="text-3xl font-bold text-teal-400">Owner Portal</h2>
                    <p class="mt-2 text-gray-400">Bulk submit and generate content.</p>
                </div>
                <div id="admin-portal-btn" class="view-button text-center p-8 bg-gray-800 rounded-xl border border-gray-700 hover:border-indigo-500 hover:bg-gray-700 transition-all duration-300 transform hover:-translate-y-1">
                    <h2 class="text-3xl font-bold text-indigo-400">Admin Dashboard</h2>
                    <p class="mt-2 text-gray-400">Manage companies and submitted reviews.</p>
                </div>
            </div>
        </div>

        <!-- Client View -->
        <div id="client-view" class="hidden"></div>
        <!-- Owner View -->
        <div id="owner-view" class="hidden"></div>
        <!-- Admin View -->
        <div id="admin-view" class="hidden"></div>
    </div>
    
    <!-- MODALS & NOTIFICATIONS -->
    <div id="login-modal-container"></div>
    <div id="generic-modal-container"></div>
    <div id="notification" class="hidden fixed bottom-5 right-5 bg-gray-800 border border-gray-700 text-white py-3 px-5 rounded-lg shadow-xl z-[10001]"></div>
    
    <script>
        // Global callback for Google Maps API
        function initMaps() {
            document.dispatchEvent(new Event('google-maps-loaded'));
        }

        document.addEventListener('DOMContentLoaded', () => {
            const app = {
                // --- STATE ---
                state: {
                    currentView: 'initial',
                    isClientLoggedIn: false, isOwnerLoggedIn: false, isAdminLoggedIn: false,
                    mapsInitialized: false,
                    data: { companies: [] },
                    activeCompanyId: localStorage.getItem('activeCompanyTab') || null,
                    clientState: { link: '', reviews: [] },
                    ownerState: {
                        activeTab: 'submitter',
                        link: '',
                        reviews: [],
                        bulkText: '',
                        promptGenerator: { input: '', output: '' },
                        placeFinder: { companyName: '', startingCount: 0, link: '' },
                        sheetRow: { qtyToday: '', totalDone: '', reviewsOrdered: '', output: '' }
                    }
                },
                // --- DOM ELEMENTS ---
                elements: {
                    app: document.getElementById('app'),
                    initialView: document.getElementById('initial-view'),
                    clientView: document.getElementById('client-view'),
                    ownerView: document.getElementById('owner-view'),
                    adminView: document.getElementById('admin-view'),
                    loginModalContainer: document.getElementById('login-modal-container'),
                    genericModalContainer: document.getElementById('generic-modal-container'),
                    notification: document.getElementById('notification'),
                },
                // --- INITIALIZATION ---
                init() {
                    this.loadData();
                    this.attachInitialListeners();
                    document.addEventListener('google-maps-loaded', () => {
                        this.state.mapsInitialized = true;
                        // If a view requiring maps is already active, initialize it now
                        if (this.state.currentView === 'owner' && this.state.ownerState.activeTab === 'tools') {
                            this.initPlaceIdFinderMap();
                        } else if (this.state.currentView !== 'initial'){
                           this.initAutocompleteForView(this.state.currentView);
                        }
                    });
                    this.render();
                },
                initAutocompleteForView(view) {
                    const inputId = view === 'owner' ? 'owner-link-input' : 'client-link-input';
                    const input = document.getElementById(inputId);
                    if (!input || input.dataset.acAttached) return;
                    const autocomplete = new google.maps.places.Autocomplete(input, { fields: ["place_id", "name", "url"], types: ["establishment"] });
                    input.dataset.acAttached = 'true';
                    autocomplete.addListener('place_changed', () => {
                        const place = autocomplete.getPlace();
                        if (place && place.place_id) {
                            const reviewLink = `https://search.google.com/local/writereview?placeid=${place.place_id}`;
                            document.dispatchEvent(new CustomEvent('placeSelected', { detail: { link: reviewLink, view: view } }));
                        }
                    });
                },
                initPlaceIdFinderMap() {
                    if (!this.state.mapsInitialized) return;
                    const mapEl = document.getElementById("map");
                    const inputEl = document.getElementById("pac-input");
                    if (!mapEl || !inputEl || inputEl.dataset.acAttached) return;

                    const map = new google.maps.Map(mapEl, { center: { lat: 1.3521, lng: 103.8198 }, zoom: 11 });
                    const autocomplete = new google.maps.places.Autocomplete(inputEl, { fields: ["place_id", "geometry", "formatted_address", "name", "user_ratings_total"] });
                    autocomplete.bindTo("bounds", map);
                    inputEl.dataset.acAttached = 'true';
                    const marker = new google.maps.Marker({ map: map });

                    autocomplete.addListener("place_changed", () => {
                        const place = autocomplete.getPlace();
                        if (!place.geometry || !place.geometry.location) return;
                        if (place.geometry.viewport) map.fitBounds(place.geometry.viewport);
                        else { map.setCenter(place.geometry.location); map.setZoom(17); }
                        marker.setPosition(place.geometry.location);
                        marker.setVisible(true);
                        
                        this.state.ownerState.placeFinder.companyName = place.name || "";
                        this.state.ownerState.placeFinder.startingCount = place.user_ratings_total || 0;
                        this.state.ownerState.placeFinder.link = "https://search.google.com/local/writereview?placeid=" + place.place_id;
                        this.render(); 
                    });
                },
                // --- DATA PERSISTENCE ---
                loadData() {
                    const savedData = localStorage.getItem('reviewDashboardData');
                    if (savedData) { this.state.data = JSON.parse(savedData); if (!this.state.data.companies) this.state.data.companies = []; }
                    const activeTab = localStorage.getItem('activeCompanyTab');
                    if (activeTab && this.state.data.companies.find(c => c.id === activeTab)) { this.state.activeCompanyId = activeTab; } 
                    else if (this.state.data.companies.length > 0) { this.state.activeCompanyId = this.state.data.companies[0].id; }
                },
                saveData() {
                    localStorage.setItem('reviewDashboardData', JSON.stringify(this.state.data));
                    this.showNotification("Admin data saved!");
                },
                // --- VIEW MANAGEMENT ---
                switchView(view) {
                    this.state.currentView = view;
                    if ((view === 'client' && !this.state.isClientLoggedIn) || (view === 'owner' && !this.state.isOwnerLoggedIn) || (view === 'admin' && !this.state.isAdminLoggedIn)) {
                        this.showLoginModal(view); return;
                    }
                    if (view === 'client') { this.state.clientState = { link: '', reviews: [] }; }
                    if (view === 'owner') { this.state.ownerState = { activeTab: 'submitter', link: '', reviews: [], bulkText: '', promptGenerator: { input: '', output: '' }, placeFinder: { companyName: '', startingCount: 0, link: '' }, sheetRow: { qtyToday: '', totalDone: '', reviewsOrdered: '', output: '' } }; }
                    if (view === 'initial') { this.state.isClientLoggedIn = this.state.isOwnerLoggedIn = this.state.isAdminLoggedIn = false; }
                    this.render();
                },
                // --- RENDERING ---
                render() {
                    const { initialView, clientView, ownerView, adminView } = this.elements;
                    initialView.classList.toggle('hidden', this.state.currentView !== 'initial');
                    clientView.classList.toggle('hidden', this.state.currentView !== 'client');
                    ownerView.classList.toggle('hidden', this.state.currentView !== 'owner');
                    adminView.classList.toggle('hidden', this.state.currentView !== 'admin');

                    if (this.state.currentView === 'client') { this.renderClientView(); setTimeout(() => this.initAutocompleteForView('client'), 50); }
                    if (this.state.currentView === 'owner') this.renderOwnerView();
                    if (this.state.currentView === 'admin') this.renderAdminView();
                },
                // --- OWNER VIEW ---
                renderOwnerView() {
                    const { activeTab } = this.state.ownerState;
                    this.elements.ownerView.innerHTML = `
                        <div class="flex justify-between items-center mb-6">
                            <button class="back-to-initial-btn text-gray-400 hover:text-white">&larr; Logout & Return</button>
                            <h1 class="text-3xl sm:text-4xl font-bold text-white text-center">Owner Portal</h1>
                            <span></span>
                        </div>
                        <div class="border-b border-gray-600 mb-6">
                            <nav class="-mb-px flex gap-4 overflow-x-auto" aria-label="Tabs">
                                <button data-tab="submitter" class="owner-tab-btn ${activeTab === 'submitter' ? 'border-teal-500 text-teal-400' : 'border-transparent text-gray-400 hover:text-gray-200'} whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm">Review Submitter</button>
                                <button data-tab="promptGenerator" class="owner-tab-btn ${activeTab === 'promptGenerator' ? 'border-teal-500 text-teal-400' : 'border-transparent text-gray-400 hover:text-gray-200'} whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm">Prompt Generator</button>
                                <button data-tab="tools" class="owner-tab-btn ${activeTab === 'tools' ? 'border-teal-500 text-teal-400' : 'border-transparent text-gray-400 hover:text-gray-200'} whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm">Place ID & Sheet Row</button>
                            </nav>
                        </div>
                        <div id="owner-submitter-view" class="${activeTab !== 'submitter' ? 'hidden' : ''}">${this.renderOwnerSubmitterView()}</div>
                        <div id="owner-prompt-generator-view" class="${activeTab !== 'promptGenerator' ? 'hidden' : ''}">${this.renderOwnerPromptGeneratorView()}</div>
                        <div id="owner-tools-view" class="${activeTab !== 'tools' ? 'hidden' : ''}">${this.renderOwnerToolsView()}</div>
                    `;
                    if (activeTab === 'submitter') { setTimeout(() => this.initAutocompleteForView('owner'), 50); }
                    if (activeTab === 'tools') { setTimeout(() => this.initPlaceIdFinderMap(), 50); }
                },
                renderOwnerSubmitterView() {
                    const { link, reviews, bulkText } = this.state.ownerState;
                    const isLinkSet = !!link;
                    const areReviewsProcessed = reviews.length > 0;
                    return `
                        <div id="owner-link-section" class="p-6 bg-gray-800 border border-gray-700 rounded-xl ${isLinkSet ? 'opacity-70' : ''}">
                             <h2 class="text-xl font-semibold text-white mb-4">Step 1: Find Business or Paste Link</h2>
                             <div class="flex flex-col sm:flex-row gap-3">
                                 <input type="text" id="owner-link-input" class="w-full p-3 bg-gray-900 border border-gray-600 rounded-lg" placeholder="Search for a business or paste link..." value="${link}" ${isLinkSet ? 'disabled' : ''}>
                                 <button id="set-owner-link-btn" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-6 rounded-lg" ${isLinkSet ? 'disabled' : ''}>${isLinkSet ? 'Link Set!' : 'Set Manually'}</button>
                             </div>
                             <p id="owner-link-error" class="text-red-400 mt-2 text-sm hidden">Invalid link.</p>
                        </div>
                        <div id="owner-bulk-section" class="mt-8 p-6 bg-gray-800 border border-gray-700 rounded-xl ${!isLinkSet || areReviewsProcessed ? 'hidden' : ''}">
                            <h2 class="text-xl font-semibold text-white mb-4">Step 2: Paste All Reviews</h2>
                            <textarea id="owner-bulk-textarea" class="w-full p-3 bg-gray-900 border border-gray-600 rounded-lg h-60 resize-y">${bulkText}</textarea>
                            <button id="process-bulk-reviews-btn" class="mt-4 w-full bg-teal-600 hover:bg-teal-700 text-white font-bold py-3 px-4 rounded-lg">Process Reviews</button>
                        </div>
                        <div id="owner-reviews-section" class="mt-8 ${!isLinkSet || !areReviewsProcessed ? 'hidden' : ''}">
                            <div class="mb-6 flex justify-between items-center">
                                <h2 class="text-xl font-semibold text-white">Step 3: Manage Reviews (${reviews.length})</h2>
                                <button id="reset-owner-reviews-btn" class="bg-yellow-600 hover:bg-yellow-700 text-white font-bold py-2 px-4 rounded-lg">Start Over</button>
                            </div>
                            <div id="owner-reviews-container">${this.renderReviewCards('owner')}</div>
                            <div class="mt-8 pt-6 border-t border-gray-700"> <button id="download-owner-file-btn" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-6 rounded-lg" ${reviews.length === 0 ? 'disabled' : ''}>Download Submission File</button> </div>
                        </div>`;
                },
                renderOwnerPromptGeneratorView() {
                    const { input, output } = this.state.ownerState.promptGenerator;
                    return `
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                            <div class="p-6 bg-gray-800 border border-gray-700 rounded-xl">
                                <h2 class="text-xl font-semibold text-white mb-4">Review Points</h2>
                                <p class="text-sm text-gray-400 mb-3">These points are auto-filled from the 'Review Submitter' tab. You can also add or edit them manually.</p>
                                <textarea id="prompt-generator-input" class="w-full p-3 bg-gray-900 border border-gray-600 rounded-lg h-80 resize-y">${input}</textarea>
                                <button id="generate-prompt-btn" class="mt-4 w-full bg-teal-600 hover:bg-teal-700 text-white font-bold py-3 px-4 rounded-lg">Generate Prompt</button>
                            </div>
                            <div class="p-6 bg-gray-800 border border-gray-700 rounded-xl">
                                <h2 class="text-xl font-semibold text-white mb-4">Generated Prompt</h2>
                                <div class="relative h-96">
                                    <pre id="prompt-generator-output" class="w-full h-full p-3 bg-gray-900 border border-gray-600 rounded-lg whitespace-pre-wrap overflow-y-auto">${output || 'Your prompt will appear here...'}</pre>
                                    <button id="copy-prompt-btn" class="absolute top-3 right-3 bg-gray-600 hover:bg-gray-500 text-white font-bold py-1 px-3 rounded-lg text-sm" ${!output ? 'disabled' : ''}>Copy</button>
                                </div>
                            </div>
                        </div>`;
                },
                renderOwnerToolsView() {
                    const { placeFinder, sheetRow } = this.state.ownerState;
                    return `
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                            <!-- Place ID Finder -->
                            <div class="p-6 bg-gray-800 border border-gray-700 rounded-xl space-y-4">
                                <h2 class="text-xl font-semibold text-white">Place ID Finder</h2>
                                <input type="text" id="pac-input" class="pac-target-input bg-gray-900 border border-gray-600 rounded-lg" placeholder="Enter a location">
                                <div id="map"></div>
                                <div class="relative mt-4">
                                    <pre class="w-full p-3 pr-16 bg-gray-900 border border-gray-600 rounded-lg whitespace-pre-wrap overflow-x-auto">${placeFinder.link || 'Review link will appear here...'}</pre>
                                    <button id="copy-place-link-btn" class="absolute top-1/2 right-3 -translate-y-1/2 bg-gray-600 hover:bg-gray-500 text-white font-bold py-1 px-3 rounded-lg text-sm" ${!placeFinder.link ? 'disabled' : ''}>Copy</button>
                                </div>
                            </div>
                            <!-- Google Sheet Row Generator -->
                            <div class="p-6 bg-gray-800 border border-gray-700 rounded-xl space-y-4 self-start">
                                <h2 class="text-xl font-semibold text-white">Google Sheet Row Generator</h2>
                                <div><label class="block text-sm font-medium text-gray-300 mb-1">Company Name</label><input type="text" value="${placeFinder.companyName}" class="w-full p-2 bg-gray-900 border border-gray-600 rounded-lg" readonly></div>
                                <div><label class="block text-sm font-medium text-gray-300 mb-1">Starting Review Count</label><input type="text" value="${placeFinder.startingCount}" class="w-full p-2 bg-gray-900 border border-gray-600 rounded-lg" readonly></div>
                                <div><label for="quantity-today" class="block text-sm font-medium text-gray-300 mb-1">Quantity Today</label><input type="number" id="quantity-today" value="${sheetRow.qtyToday}" class="w-full p-2 bg-gray-900 border border-gray-600 rounded-lg"></div>
                                <div><label for="total-done" class="block text-sm font-medium text-gray-300 mb-1">Total Done</label><input type="number" id="total-done" value="${sheetRow.totalDone}" class="w-full p-2 bg-gray-900 border border-gray-600 rounded-lg"></div>
                                <div><label for="reviews-ordered" class="block text-sm font-medium text-gray-300 mb-1">Reviews Ordered</label><input type="number" id="reviews-ordered" value="${sheetRow.reviewsOrdered}" class="w-full p-2 bg-gray-900 border border-gray-600 rounded-lg"></div>
                                <button id="generate-sheet-row-btn" class="w-full bg-teal-600 hover:bg-teal-700 text-white font-bold py-2 px-4 rounded-lg">Generate Row</button>
                                <div class="relative">
                                    <pre id="sheet-output" class="w-full p-3 pr-16 bg-gray-900 border border-gray-600 rounded-lg whitespace-pre-wrap overflow-x-auto">${sheetRow.output || 'Sheet row will appear here...'}</pre>
                                    <button id="copy-sheet-row-btn" class="absolute top-1/2 right-3 -translate-y-1/2 bg-gray-600 hover:bg-gray-500 text-white font-bold py-1 px-3 rounded-lg text-sm" ${!sheetRow.output ? 'disabled' : ''}>Copy</button>
                                </div>
                            </div>
                        </div>`;
                },
                // --- CLIENT VIEW ---
                renderClientView() {
                    const { link, reviews } = this.state.clientState;
                    const isLinkSet = !!link;
                    this.elements.clientView.innerHTML = `
                        <div class="flex justify-between items-center mb-8">
                            <button class="back-to-initial-btn text-gray-400 hover:text-white">&larr; Logout & Return</button>
                            <button id="how-to-use-btn" class="bg-gray-700 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-lg">? How to Use</button>
                        </div>
                        <header class="mb-8"><h1 class="text-3xl sm:text-4xl font-bold text-white">Client Review Submission</h1></header>
                        <div id="client-link-section" class="mt-8 p-6 bg-gray-800 border border-gray-700 rounded-xl ${isLinkSet ? 'opacity-70' : ''}">
                             <h2 class="text-xl font-semibold text-white mb-4">Step 1: Find Business or Paste Link</h2>
                             <div class="flex flex-col sm:flex-row gap-3">
                                 <input type="text" id="client-link-input" class="w-full p-3 bg-gray-900 border border-gray-600 rounded-lg" placeholder="Search for a business or paste link..." value="${link}" ${isLinkSet ? 'disabled' : ''}>
                                 <button id="set-client-link-btn" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-6 rounded-lg" ${isLinkSet ? 'disabled' : ''}>${isLinkSet ? 'Link Set!' : 'Set Manually'}</button>
                             </div>
                        </div>
                        <div id="client-reviews-section" class="mt-8 ${!isLinkSet ? 'hidden' : ''}">
                            <div class="mb-6">
                                <h2 class="text-xl font-semibold text-white mb-4">Step 2: Add Your Reviews (${reviews.length})</h2>
                                <button id="add-client-review-btn" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg">Add New Review</button>
                            </div>
                            <div id="client-reviews-container">${this.renderReviewCards('client')}</div>
                            <div class="mt-8 pt-6 border-t border-gray-700"> <button id="download-client-file-btn" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-6 rounded-lg" ${reviews.length === 0 ? 'disabled' : ''}>Download Submission File</button> </div>
                        </div>`;
                },
                // --- GENERIC REVIEW CARD RENDERER ---
                renderReviewCards(viewType) {
                    const state = viewType === 'owner' ? this.state.ownerState : this.state.clientState;
                    const { reviews } = state;
                    const cardColor = viewType === 'owner' ? 'teal' : 'blue';

                    if(reviews.length === 0) {
                         if (viewType === 'client') return '<p class="text-gray-400 text-center py-4">No reviews added yet. Click "Add New Review" to start.</p>';
                         return '<p class="text-gray-400 text-center py-4">No reviews processed yet. Paste reviews in the box above and click "Process Reviews".</p>';
                    }
                    
                    return reviews.map((review, index) => `
                        <div class="review-item bg-gray-800 p-6 rounded-xl mb-6 border border-gray-700">
                            <div class="flex justify-between items-start mb-4">
                                <span class="text-2xl font-bold text-${cardColor}-400">#${index + 1}</span>
                                <button data-view="${viewType}" data-index="${index}" class="remove-review-btn text-gray-500 hover:text-red-500 font-bold text-2xl">&times;</button>
                            </div>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div>
                                    <label class="font-semibold text-gray-300 mb-2 block">Review Content</label>
                                    <textarea data-view="${viewType}" data-index="${index}" class="content-input w-full p-3 bg-gray-900 border border-gray-600 rounded-lg h-40 resize-none">${review.text}</textarea>
                                </div>
                                <div>
                                    <div class="mb-2">
                                        <label class="font-semibold text-gray-300 cursor-pointer">
                                            <input type="checkbox" data-view="${viewType}" data-index="${index}" class="image-required-toggle mr-2 accent-${cardColor}-500" ${review.requiresImage ? 'checked' : ''}>
                                            This review requires image(s)
                                        </label>
                                    </div>
                                    <div class="image-upload-section ${review.requiresImage ? '' : 'hidden'}">
                                        <label class="font-semibold text-gray-300 mb-2 block">Images</label>
                                        <div class="image-previews-container grid grid-cols-3 gap-2 mb-2">
                                            ${(review.imageDataUrls || []).map((url, imgIndex) => `
                                                <div class="relative group">
                                                    <img src="${url}" class="w-full h-24 object-cover rounded-lg">
                                                    <button data-view="${viewType}" data-review-index="${index}" data-image-index="${imgIndex}" class="remove-image-btn absolute top-1 right-1 bg-red-600 text-white rounded-full w-5 h-5 flex items-center justify-center text-xs opacity-0 group-hover:opacity-100 transition-opacity">&times;</button>
                                                </div>
                                            `).join('')}
                                        </div>
                                        <label class="file-input-button w-full h-12 bg-gray-900 border-2 border-dashed border-gray-600 rounded-lg flex items-center justify-center text-sm text-gray-500 hover:bg-gray-700 hover:text-white">
                                            Click to upload images
                                            <input type="file" data-view="${viewType}" data-index="${index}" class="image-input hidden" accept="image/*" multiple>
                                        </label>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `).join('');
                },
                // --- ADMIN VIEW (Full implementation) ---
                renderAdminView() {
                    this.elements.adminView.innerHTML = `
                        <div class="flex justify-between items-center mb-8">
                            <h1 class="text-3xl sm:text-4xl font-bold text-white">Admin Dashboard</h1>
                            <button class="back-to-initial-btn text-gray-400 hover:text-white">&larr; Logout & Return</button>
                        </div>
                        <div class="bg-gray-800 p-6 rounded-xl border border-gray-700 self-start">
                             <h2 class="text-xl font-semibold text-white mb-4">Manage Companies</h2>
                             <div class="flex flex-col sm:flex-row gap-4">
                                 <input type="text" id="new-company-name" class="w-full p-2 bg-gray-900 border border-gray-600 rounded-lg" placeholder="New company name...">
                                 <button id="add-company-btn" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-6 rounded-lg whitespace-nowrap">Add Company</button>
                             </div>
                        </div>
                        <main id="admin-main-content" class="mt-8">
                            ${this.renderAdminMainContent()}
                        </main>
                    `;
                },
                renderAdminMainContent() {
                    const companies = this.state.data.companies;
                    if (companies.length === 0) return `<div class="text-center py-16 px-6 bg-gray-800 rounded-lg"><h3 class="text-xl font-semibold text-white">No Companies Added</h3><p class="text-gray-400 mt-2">Please add a company to begin.</p></div>`;
                    const company = companies.find(c => c.id === this.state.activeCompanyId);
                    return `
                        <div class="sticky-tabs border-b border-gray-600 mb-6">
                            <nav class="-mb-px flex gap-4 overflow-x-auto" aria-label="Tabs">
                                ${companies.map(c => `
                                    <button data-id="${c.id}" class="company-tab-btn group inline-flex items-center py-4 px-1 border-b-2 font-medium text-sm whitespace-nowrap ${this.state.activeCompanyId === c.id ? 'border-indigo-500 text-indigo-400' : 'border-transparent text-gray-400 hover:text-gray-200 hover:border-gray-500'}">
                                        ${c.name}
                                    </button>
                                `).join('')}
                            </nav>
                        </div>
                        ${company ? this.renderAdminCompanyDetails(company) : `<div class="text-center py-16 px-6 bg-gray-800 rounded-lg"><p class="text-gray-400 mt-2">Select a company tab to view its details.</p></div>`}
                    `;
                },
                renderAdminCompanyDetails(company) {
                    const totalReviews = company.reviews?.length || 0;
                    const doneReviews = company.reviews?.filter(r => r.status === 'done').length || 0;
                    const progress = totalReviews > 0 ? (doneReviews / totalReviews) * 100 : 0;
                    const undoneReviews = company.reviews?.filter(r => r.status !== 'done') || [];
                    return `
                        <div class="bg-gray-800 p-6 rounded-xl border border-gray-700 mb-8">
                            <div class="flex flex-wrap justify-between items-start gap-4 mb-4">
                                <div>
                                  <h2 class="text-2xl font-bold text-white">${company.name}</h2>
                                  <a href="${company.reviewLink || '#'}" target="_blank" class="text-sm text-indigo-400 hover:underline break-all">${company.reviewLink || 'No review link set yet.'}</a>
                                </div>
                                <div class="grid grid-cols-2 gap-3 w-full md:w-auto">
                                    <button data-id="${company.id}" class="copy-latest-undone-btn bg-teal-600 hover:bg-teal-700 text-white font-bold py-2 px-4 rounded-lg" ${undoneReviews.length === 0 ? 'disabled' : ''}>Copy Latest</button>
                                    <label class="file-input-button bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg text-center">
                                        Upload File <input type="file" data-id="${company.id}" class="upload-admin-file hidden" accept=".json">
                                    </label>
                                    <button data-id="${company.id}" class="download-admin-file-btn bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg">Download</button>
                                    <button data-id="${company.id}" class="remove-company-btn bg-red-800 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg">Delete</button>
                                </div>
                            </div>
                            <div>
                                <div class="flex justify-between mb-1">
                                    <span class="text-base font-medium text-indigo-400">Completion</span>
                                    <span class="text-sm font-medium text-indigo-400">${doneReviews} / ${totalReviews} (${Math.round(progress)}%)</span>
                                </div>
                                <div class="w-full bg-gray-700 rounded-full h-2.5"> <div class="bg-indigo-600 h-2.5 rounded-full" style="width: ${progress}%"></div> </div>
                            </div>
                        </div>
                        <div id="admin-reviews-container">
                            ${company.reviews && company.reviews.length > 0 ? company.reviews.map((review, index) => this.getAdminReviewHtml(company, review, index)).join('') : `<div class="text-center py-16 px-6 bg-gray-800 rounded-lg"><p class="text-gray-400">No reviews submitted for this company yet. Upload a client file.</p></div>`}
                        </div>
                    `;
                },
                getAdminReviewHtml(company, review, index) {
                    const isDone = review.status === 'done';
                    const hasImages = review.requiresImage && review.imageDataUrls && review.imageDataUrls.length > 0;
                    return `
                        <div class="review-item relative bg-gray-800 p-6 rounded-xl mb-6 shadow-lg border ${isDone ? 'border-green-500 opacity-60' : 'border-gray-700'}">
                            ${isDone ? '<span class="absolute top-3 right-3 bg-green-600 text-white text-xs font-bold px-2 py-1 rounded-full">DONE</span>' : ''}
                            <div class="flex justify-between items-start mb-4"> <span class="text-2xl font-bold text-indigo-400">#${index + 1}</span> </div>
                            <div class="grid grid-cols-1 ${hasImages ? 'md:grid-cols-2' : ''} gap-6">
                                <div class="space-y-2">
                                    <p class="font-semibold text-gray-300">Review Content:</p>
                                    <p class="p-3 bg-gray-900 border border-gray-600 rounded-lg whitespace-pre-wrap">${review.text}</p>
                                </div>
                                ${hasImages ? `<div> <p class="font-semibold text-gray-300 mb-2">Submitted Images:</p> <div class="grid grid-cols-2 sm:grid-cols-3 gap-2"> ${review.imageDataUrls.map((url, imgIndex) => `<img src="${url}" data-review-index="${index}" data-image-index="${imgIndex}" class="admin-image-preview w-full h-24 object-cover rounded-lg cursor-pointer hover:opacity-80 transition-opacity">`).join('')} </div> </div>` : ''}
                            </div>
                             <div class="mt-6 pt-4 border-t border-gray-700 flex flex-wrap gap-3">
                                 ${isDone ? `<button data-index="${index}" class="undo-review-btn flex-1 bg-yellow-600 hover:bg-yellow-700 text-white font-bold py-2 px-4 rounded-lg">Undo</button>` : `<button data-index="${index}" class="copy-btn flex-1 bg-teal-600 hover:bg-teal-700 text-white font-bold py-2 px-4 rounded-lg">Copy for Telegram</button>`}
                                 ${hasImages ? `<button data-index="${index}" class="save-image-btn flex-1 bg-gray-600 hover:bg-gray-500 text-white font-bold py-2 px-4 rounded-lg">Save All Images</button>` : ''}
                            </div>
                        </div>`;
                },
                // --- EVENT LISTENERS ---
                attachInitialListeners() {
                    document.getElementById('client-portal-btn').addEventListener('click', () => this.switchView('client'));
                    document.getElementById('owner-portal-btn').addEventListener('click', () => this.switchView('owner'));
                    document.getElementById('admin-portal-btn').addEventListener('click', () => this.switchView('admin'));
                    this.elements.app.addEventListener('click', e => { if (e.target.closest('.back-to-initial-btn')) { this.switchView('initial'); } this.handleGenericClick(e); });
                    this.elements.app.addEventListener('input', e => this.handleGenericInput(e));
                    this.elements.app.addEventListener('change', e => this.handleGenericChange(e));
                    document.addEventListener('placeSelected', e => this.handlePlaceSelected(e));
                },
                // --- EVENT HANDLERS ---
                handleOwnerTabClick(tab) {
                    this.state.ownerState.activeTab = tab;
                    if (tab === 'promptGenerator' && this.state.ownerState.reviews.length > 0) {
                        this.state.ownerState.promptGenerator.input = this.state.ownerState.reviews.map(r => r.text).join('\n\n');
                    }
                    this.render();
                },
                handleGenericClick(e) {
                    const target = e.target;
                    const view = this.state.currentView;
                    if (target.closest('.owner-tab-btn')) { this.handleOwnerTabClick(target.closest('.owner-tab-btn').dataset.tab); return; }

                    // --- Client & Owner Shared ---
                    if (target.id === `set-${view}-link-btn` && (view === 'client' || view === 'owner')) {
                        const input = document.getElementById(`${view}-link-input`);
                        const link = input.value;
                        if (this.validateLink(link)) { this.state[`${view}State`].link = link; this.render(); } 
                    }
                    if (target.closest('.remove-review-btn')) {
                        const btn = target.closest('.remove-review-btn');
                        this.state[`${btn.dataset.view}State`].reviews.splice(btn.dataset.index, 1);
                        this.render();
                    }
                    if (target.closest('.remove-image-btn')) {
                        const btn = target.closest('.remove-image-btn');
                        this.state[`${btn.dataset.view}State`].reviews[btn.dataset.reviewIndex].imageDataUrls.splice(btn.dataset.imageIndex, 1);
                        this.render();
                    }
                     if (target.id === `download-${view}-file-btn`) {
                        this.showPromptModal('Enter a filename', 'e.g., yourname_reviews', (filename) => {
                            if (!filename) { this.showNotification('Download cancelled.', 'error'); return; }
                            const safeFilename = filename.replace(/\s+/g, '_').replace(/[^a-zA-Z0-9_.-]/g, '');
                            const dataBlob = new Blob([JSON.stringify(this.state[`${view}State`], null, 2)], { type: 'application/json' });
                            const url = URL.createObjectURL(dataBlob);
                            const a = document.createElement('a');
                            a.href = url; a.download = `${safeFilename}.json`;
                            document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(url);
                            this.showNotification('File downloaded! Please send it to us.');
                            this.state[`${view}State`] = { link: '', reviews: view === 'owner' ? [] : [], bulkText: '' };
                            this.render();
                        });
                    }

                    // --- Client Specific ---
                    if (view === 'client') {
                        if (target.id === 'how-to-use-btn') this.showInfoModal('How to Use the Client Portal', `<ol class="list-decimal list-inside space-y-3"><li><strong>Find Business:</strong> Use the search bar to find the business. Or, paste the Google Review link and click "Set Manually".</li><li><strong>Add Reviews:</strong> Click "Add New Review" to create a card.</li><li><strong>Write Content:</strong> Type your review in the text box.</li><li><strong>Add Images:</strong> Check the "This review requires image(s)" box to show the uploader. Click it to select one or more pictures.</li><li><strong>Download File:</strong> When done, click "Download Submission File".</li><li><strong>Name Your File:</strong> A pop-up will ask for a filename (e.g., 'yourname_reviews').</li><li><strong>Send to Admin:</strong> The file will download to your device. Please send this <code>.json</code> file to the administrator.</li></ol>`); 
                        if (target.id === 'add-client-review-btn') { this.state.clientState.reviews.unshift({ text: '', requiresImage: false, imageDataUrls: [] }); this.render(); }
                    }

                    // --- Owner Specific ---
                    if (view === 'owner') {
                        if (target.id === 'process-bulk-reviews-btn') this.processBulkReviews();
                        if (target.id === 'reset-owner-reviews-btn') { this.state.ownerState.reviews = []; this.state.ownerState.bulkText = ''; this.render(); }
                        if (target.id === 'generate-prompt-btn') this.generateOwnerPrompt();
                        if (target.id === 'copy-prompt-btn') this.copyToClipboard(this.state.ownerState.promptGenerator.output, "Prompt copied!");
                        if (target.id === 'copy-place-link-btn') this.copyToClipboard(this.state.ownerState.placeFinder.link, "Place link copied!");
                        if (target.id === 'generate-sheet-row-btn') this.generateSheetRow();
                        if (target.id === 'copy-sheet-row-btn') this.copyToClipboard(this.state.ownerState.sheetRow.output, "Sheet row copied!");
                    }
                    
                    // --- Admin Specific ---
                    if (view === 'admin') { this.handleAdminClick(e); }
                },
                 handleAdminClick(e) {
                    const target = e.target;
                    
                    if(target.id === 'add-company-btn') {
                        const nameInput = document.getElementById('new-company-name');
                        if (nameInput.value.trim()) {
                            const newCompany = { id: `comp_${Date.now()}`, name: nameInput.value.trim(), reviewLink: '', reviews: [] };
                            this.state.data.companies.push(newCompany);
                            this.state.activeCompanyId = newCompany.id;
                            this.saveData(); this.render(); nameInput.value = '';
                        }
                    }
                    if(target.closest('.company-tab-btn')) { 
                        this.state.activeCompanyId = target.closest('.company-tab-btn').dataset.id; 
                        localStorage.setItem('activeCompanyTab', this.state.activeCompanyId);
                        this.render(); 
                    }
                    if(target.closest('.remove-company-btn')) {
                        const id = target.closest('.remove-company-btn').dataset.id;
                        this.showConfirmModal('Delete Company?', 'This cannot be undone.', () => {
                            this.state.data.companies = this.state.data.companies.filter(c => c.id !== id);
                            if (this.state.activeCompanyId === id) {
                                this.state.activeCompanyId = this.state.data.companies[0]?.id || null;
                                localStorage.setItem('activeCompanyTab', this.state.activeCompanyId);
                            }
                            this.saveData(); this.render();
                        });
                    }
                    
                    const company = this.state.data.companies.find(c => c.id === this.state.activeCompanyId);
                    if(!company) return;

                    const reviewIndex = e.target.closest('[data-review-index]')?.dataset.reviewIndex ?? e.target.closest('[data-index]')?.dataset.index;
                    
                    if (target.closest('.copy-latest-undone-btn')) {
                        const latestUndone = company.reviews.map((r, i) => ({...r, originalIndex: i})).reverse().find(r => r.status !== 'done');
                        if (latestUndone) {
                            this.copyToClipboard(`Click: ${company.reviewLink}\n\n\`${latestUndone.text}\``, 'Latest review copied!');
                            company.reviews[latestUndone.originalIndex].status = 'done';
                            this.saveData(); this.render();
                        } else { this.showNotification('No new reviews to copy.'); }
                        return;
                    }
                     if (target.closest('.download-admin-file-btn')) {
                        const companyToDownload = this.state.data.companies.find(c => c.id === target.dataset.id);
                        const dataBlob = new Blob([JSON.stringify(companyToDownload, null, 2)], { type: 'application/json' });
                        const url = URL.createObjectURL(dataBlob);
                        const a = document.createElement('a');
                        a.href = url; a.download = `data_${companyToDownload.name.replace(/\s+/g, '_')}.json`;
                        document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(url);
                        return;
                    }

                    if (!reviewIndex) return;
                    const review = company.reviews[reviewIndex];

                    if (target.closest('.copy-btn')) {
                        this.copyToClipboard(`Click: ${company.reviewLink}\n\n\`${review.text}\``, 'Review copied!');
                        review.status = 'done';
                        this.saveData(); this.render();
                    }
                    if (target.closest('.undo-review-btn')) {
                        review.status = 'undone';
                        this.saveData(); this.render();
                    }
                    if (target.closest('.save-image-btn')) {
                         review.imageDataUrls.forEach((url, i) => {
                             const a = document.createElement('a');
                             a.href = url;
                             a.download = `review_image_${company.name}_${parseInt(reviewIndex) + 1}_${i + 1}.jpeg`;
                             document.body.appendChild(a); a.click(); document.body.removeChild(a);
                         });
                    }
                    if (target.closest('.admin-image-preview')) {
                        const imgIndex = e.target.dataset.imageIndex;
                        this.showImageModal(review.imageDataUrls[imgIndex]);
                    }
                },
                handleGenericInput(e) {
                    const target = e.target;
                    const view = target.dataset.view;
                     if (target.classList.contains('content-input') && (view === 'client' || view === 'owner')) {
                        this.state[`${view}State`].reviews[target.dataset.index].text = target.value;
                    }
                     if (target.id === 'owner-bulk-textarea') {
                        this.state.ownerState.bulkText = target.value;
                    }
                    if (target.id === 'prompt-generator-input') {
                        this.state.ownerState.promptGenerator.input = target.value;
                    }
                    if (['quantity-today', 'total-done', 'reviews-ordered'].includes(target.id)) {
                        const key = {
                            'quantity-today': 'qtyToday',
                            'total-done': 'totalDone',
                            'reviews-ordered': 'reviewsOrdered'
                        }[target.id];
                        this.state.ownerState.sheetRow[key] = target.value;
                    }
                },
                async handleGenericChange(e) {
                    const target = e.target;
                    const view = target.dataset.view;
                    const index = target.dataset.index;
                    if (target.classList.contains('image-required-toggle') && (view === 'client' || view === 'owner')) {
                        this.state[`${view}State`].reviews[index].requiresImage = target.checked;
                        if (!target.checked) { this.state[`${view}State`].reviews[index].imageDataUrls = []; }
                        this.render();
                    }
                    if (target.classList.contains('image-input') && (view === 'client' || view === 'owner')) {
                        const files = target.files;
                        if (files.length > 0) {
                            this.showNotification(`Compressing ${files.length} image(s)...`, 'info');
                            for (const file of files) {
                                try {
                                    const compressedDataUrl = await this.compressImage(file);
                                    this.state[`${view}State`].reviews[index].imageDataUrls.push(compressedDataUrl);
                                } catch (err) { this.showNotification(`Could not process ${file.name}.`, 'error'); }
                            }
                            this.render();
                            this.showNotification('Images added successfully.');
                        }
                    }
                     if (this.state.currentView === 'admin' && e.target.classList.contains('upload-admin-file')) {
                        this.handleAdminChange(e);
                    }
                },
                 handleAdminChange(e) {
                    if (e.target.classList.contains('upload-admin-file')) {
                        const file = e.target.files[0];
                        const companyId = e.target.dataset.id;
                        if (file && companyId) {
                             const reader = new FileReader();
                             reader.onload = (event) => {
                                 try {
                                     const uploaded = JSON.parse(event.target.result);
                                     if (this.validateLink(uploaded.link) && Array.isArray(uploaded.reviews)) {
                                         const company = this.state.data.companies.find(c => c.id === companyId);
                                         if(company) {
                                             company.reviewLink = uploaded.link;
                                             const existingReviewTexts = new Set((company.reviews || []).map(r => r.text));
                                             const newReviews = uploaded.reviews.filter(r => !existingReviewTexts.has(r.text)).map(r => ({...r, status: 'undone'}));
                                             company.reviews = [...newReviews, ...company.reviews || []];
                                             this.saveData(); this.render();
                                             this.showNotification(`${newReviews.length} new review(s) imported.`);
                                         }
                                     } else { this.showNotification('Invalid file format.', 'error'); }
                                 } catch (err) { this.showNotification('Error reading file.', 'error'); } 
                                 finally { e.target.value = ''; }
                             };
                             reader.readAsText(file);
                        }
                    }
                },
                handlePlaceSelected(e) { 
                    const { link, view } = e.detail;
                    if(this.state.currentView === view && this.validateLink(link)) {
                        this.state[`${view}State`].link = link;
                        this.render();
                    } 
                },
                // --- OWNER-SPECIFIC METHODS ---
                processBulkReviews() {
                    const { bulkText } = this.state.ownerState;
                    const lines = bulkText.split('\n').map(line => line.trim()).filter(line => line.length > 0);
                    const uniqueLines = [...new Set(lines)];
                    if (uniqueLines.length === 0) { this.showNotification("No reviews found to process.", "error"); return; }
                    this.state.ownerState.reviews = uniqueLines.map(line => ({ text: line, requiresImage: false, imageDataUrls: [] }));
                    this.showNotification(`${uniqueLines.length} unique reviews processed.`, "success");
                    this.render();
                },
                generateOwnerPrompt() {
                    const extraInput = this.state.ownerState.promptGenerator.input.trim();
                    const points = extraInput ? extraInput : "the points above";
                    if (!extraInput) { this.showNotification("Please provide some review points first.", "error"); return; }
                    const promptText = `${points}\n\nbased on the points above Craft 50 positive detailed reviews based on the above context and strictly follow the requirements outlined below\nRequirements:\n- Company Name Usage: Do not include the company name in every review. Only insert it into some of the reviews (e.g., Reviews 1, 3, 5, 7, and 10). The rest should use general terms like “the team,” “the service,” “they,” or refer to the experience without naming the company. This prevents repetition and makes the reviews sound more natural.\n\nSentence Structure Variety: Avoid repeating the same sentence pattern across all reviews. Do not follow a fixed format like:\n“John is the best! The service was amazing. Highly recommended!”\nInstead, vary the tone, style, and flow:\n\nStart some reviews with a personal story\n\nUse different emotional tones (excited, grateful, surprised, relaxed, etc.)\n\nMix short and long sentences\n\nVary the structure: some can be casual, others formal or descriptive\n\nRealism and Authenticity: Make it sound like 10 different real people wrote the reviews. Include specific, realistic details, and even small flaws or neutral remarks followed by praise in one or two reviews (e.g., “Had to wait 5 minutes, but it was worth it”), to improve credibility.\n\nRandomize the Review Lengths: Do not make all reviews long, all short, or follow a predictable pattern like alternating between long and short. Instead, randomize the length of each review naturally.\n\nSome reviews should be short and snappy (e.g., 5–10 words: “Fast service. Super satisfied!” or “Will return. Great experience.”)\n\nOthers should be medium length (2–4 sentences), and a few should be long and detailed (4–8+ sentences with specific details and storytelling).\n\nAvoid Patterns: The order of lengths should feel random, like:\nLong, short, short, long, medium, short, long, short, long, medium\nThis prevents detection when reviews are posted in sequence and makes the overall output more human-like.\n\nVocabulary Variety – Prioritize Simplicity, Mix in Depth:\nMost reviews should use simple, everyday English—casual tone, easy vocabulary, and natural phrasing that resembles how an average person would write a quick review. Avoid sounding too polished or robotic.\nHowever, include 1 or 2 reviews that use slightly more advanced vocabulary or articulate phrasing, as if written by a well-spoken or expressive customer. This adds realism and makes the full set of reviews sound more diverse and believable.\nExamples:\n\nSimple: “Fast service, friendly staff. Will come back.”\n\nSlightly refined: “From start to finish, the entire process was smooth, efficient, and exceeded my expectations.”\n\nAvoid Overly Promotional or Dramatic Tone:\nThe reviews should sound natural and conversational, like something a real customer would post—not exaggerated or overly enthusiastic. Avoid phrases that sound scripted, fake, or too good to be true (e.g., “Absolutely flawless!”, “10/10 best ever!”, “I’m speechless!”).\nInstead, use subtle praise, realistic appreciation, and moderate expressions. Some reviews can include small imperfections or minor observations (e.g., “Had to wait a bit, but it was worth it”) to sound more believable.\nThe goal is to make the reviews feel like genuine customer reflections, not advertising.\n\nVary Writing Voice Slightly:\nConsider introducing slight differences in writing style—some reviews can be casual and relaxed (“super chill vibe, loved it”), while others are more formal or proper. One or two may include emojis or casual lingo to mimic the variety of people on Google. You can even include 1 broken-English style review if the brand serves a wide customer base.\n\nRandomized Capitalization Styles:\nVary capitalization across different reviews to reflect real-world typing habits. Some reviews should follow proper sentence case (e.g., “The service was great.”), while others should reflect auto-capitalization being off or inconsistent (e.g., “great experience. will definitely return.”). This variation should be randomly spread out, not patterned. Do not apply improper casing to all or most reviews—only a few should use it inconsistently to mimic natural human typing.\n\nLow-Frequency Emoji Usage:\nInclude emojis in only 1 out of every 10 reviews (or fewer). The emoji should be context-appropriate (e.g., 😊, 👍, 🙌), and placed naturally at the end or mid-sentence. Avoid overusing emojis or putting them in every review, as that reduces authenticity. Most real users don’t use emojis in Google reviews—only the occasional expressive person does.\n\nAvoid Non-Standard Punctuation:\nDo not use unusual punctuation marks like colons (:), semicolons (;), dashes (-) or em dashes (—) within reviews. Real reviewers rarely take the time to format their writing this precisely. Stick to simple, natural punctuation: periods (.), commas (,), exclamation points (!) used sparingly, and question marks (?) only when contextually necessary.\n\nInclude Casual Time References in Some Reviews:\nIn 3 reviews, include a soft time reference like “visited last week,” “came here yesterday,” “this morning was my first time,” or “been here twice this month.” This adds a sense of real-time behavior and improves believability.\n\nVary Reviewer Contexts Subtly:\nIn a few reviews, mention small contextual clues that hint at different demographics or scenarios (e.g., “great spot for a quick lunch break,” “brought my kids and they loved it,” “perfect after a long day at work”). This helps make the pool of reviews feel like they came from diverse customers.\n\nUse Specific, Natural Details Without Copying Full Names:\nWhen known, include realistic and specific references to services, products, staff, or actions (e.g., “the sambal chicken was crispy,” “Jane at the front desk was super helpful,” “checkout was quick and smooth”). These details add realism and depth to the review.\nHowever, do not quote full item names exactly as listed in menus, brochures, or catalogs. Simplify them into natural, conversational descriptions, as a real customer would say casually.\nFor example:\n\n❌ “Three Piece Fried Chicken with Sambal Chilli and Coke with Mayo Sauce – Best Seller”\n✅ “Tried the sambal chicken combo it is delicious.”\n\n❌ “Premium Platinum Lock Installation with NFC Key System”\n✅ “They installed an NFC lock for me super smooth process.”\n\nAvoid Repeating the Same Business or Item Names Across Consecutive Reviews:\nDo not repeat the exact business name, product name, food name, or service name in multiple reviews back-to-back. Spread them out randomly across the full set of reviews.\n\nOnly include the business name in a few randomly selected reviews, not in all. The rest should refer to the business with general terms like “this place,” “the team,” “the restaurant,” or skip naming entirely.\n\nSimilarly, if referencing food or product names (e.g., “salted egg pork rib”, “crispy chicken mid wings”), do not repeat the same item across reviews unless it makes natural sense (e.g., being a top-seller). Even then, ensure the phrasing is varied and mention is spaced out—not clustered together.\n\n✔️ Examples:\n\n“Had dinner at Golden Spoon Seafood last night…”\n\n“This spot serves the crispiest cereal prawns.”\n\n“We tried the pork rib dish—real comfort food.”\n\n“Kids loved the fried stuff, portions were generous.”\n\nThis spacing makes the reviews feel like they were written by different people on different days, and prevents artificial repetition.\n\ntrict Limit on Business Name Mentions (Per 5 Reviews):\nTo maintain realism and avoid obvious patterns, only mention the business or brand name once for every 5 reviews. The rest should use general references like “this place,” “the restaurant,” “the team,” or no name at all.\nWithin each 5-review block, randomize which review contains the business name—do not always use it in the 1st or 5th review.\nThis means:\n\nReviews 1–5 → only one should contain the brand name (randomly selected)\n\nReviews 6–10 → again, only one\n\nReviews 11–15 → same rule applies and so on for the rest of the reviews\n\nThis rule applies regardless of total review count, ensuring name usage is well-distributed and never repetitive.\n\nFormatting the reviews, do not number the reviews. Separate each review with a new line. \n\nExample format:\n\ncontent 1 \n\ncontent 2`;
                    this.state.ownerState.promptGenerator.output = promptText;
                    this.render();
                    this.showNotification("Prompt generated!");
                },
                generateSheetRow() {
                    const { companyName, startingCount } = this.state.ownerState.placeFinder;
                    if (!companyName) { this.showNotification("Please search and select a company first.", "error"); return; }
                    const qToday = parseInt(this.state.ownerState.sheetRow.qtyToday, 10) || 0;
                    const tDone = parseInt(this.state.ownerState.sheetRow.totalDone, 10) || 0;
                    const rOrdered = parseInt(this.state.ownerState.sheetRow.reviewsOrdered, 10) || 0;
                    const endingCount = startingCount + rOrdered;
                    const reviewsLeft = rOrdered - tDone;
                    this.state.ownerState.sheetRow.output = `${companyName}\t${qToday}\t${tDone}\t${rOrdered}\t${startingCount}\t${endingCount}\t\t${reviewsLeft}`;
                    this.render();
                },
                // --- UTILITIES & MODALS ---
                compressImage(file, quality = 0.7, maxWidth = 1024) {
                    return new Promise((resolve, reject) => {
                        const reader = new FileReader();
                        reader.readAsDataURL(file);
                        reader.onload = (event) => {
                            const img = new Image();
                            img.src = event.target.result;
                            img.onload = () => {
                                const canvas = document.createElement('canvas');
                                const scaleRatio = maxWidth / img.width;
                                canvas.width = scaleRatio < 1 ? maxWidth : img.width;
                                canvas.height = scaleRatio < 1 ? img.height * scaleRatio : img.height;
                                const ctx = canvas.getContext('2d');
                                ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                                resolve(ctx.canvas.toDataURL('image/jpeg', quality));
                            };
                            img.onerror = (error) => reject(error);
                        };
                        reader.onerror = (error) => reject(error);
                    });
                },
                showLoginModal(type) {
                    const titles = { client: 'Client Login', owner: 'Owner Login', admin: 'Admin Login' };
                    const credentials = { client: {u: 'client', p: 'client'}, owner: {u: 'owner', p: 'owner'}, admin: {u: 'admin', p: 'admin'} };
                    const colors = { client: 'blue', owner: 'teal', admin: 'indigo' };
                    const title = titles[type]; const correctUser = credentials[type].u; const correctPass = credentials[type].p; const color = colors[type];
                    this.elements.loginModalContainer.innerHTML = `
                        <div id="login-modal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-[10000]">
                            <div class="bg-gray-800 p-8 rounded-xl shadow-2xl w-full max-w-sm border border-gray-700">
                                <h2 class="text-2xl font-bold text-white mb-6">${title}</h2>
                                <form id="login-form">
                                    <div class="mb-4"><label for="username" class="block text-gray-300 mb-2">Username</label><input type="text" id="username" class="w-full p-3 bg-gray-900 border border-gray-600 rounded-lg focus:ring-2 focus:ring-${color}-500"></div>
                                    <div class="mb-6"><label for="password" class="block text-gray-300 mb-2">Password</label><input type="password" id="password" class="w-full p-3 bg-gray-900 border border-gray-600 rounded-lg focus:ring-2 focus:ring-${color}-500"></div>
                                    <p id="login-error" class="text-red-400 text-sm mb-4 hidden">Invalid credentials.</p>
                                    <div class="flex items-center justify-between">
                                        <button type="button" class="cancel-login-btn text-gray-400 hover:text-white">Cancel</button>
                                        <button type="submit" class="text-white font-bold py-2 px-6 rounded-lg bg-${color}-600 hover:bg-${color}-700">Login</button>
                                    </div>
                                </form>
                            </div>
                        </div>`;
                    const form = this.elements.loginModalContainer.querySelector('#login-form');
                    form.querySelector('#username').focus();
                    form.onsubmit = (e) => {
                        e.preventDefault();
                        const user = form.querySelector('#username').value;
                        const pass = form.querySelector('#password').value;
                        if (user === correctUser && pass === correctPass) {
                            if (type === 'client') this.state.isClientLoggedIn = true;
                            if (type === 'owner') this.state.isOwnerLoggedIn = true;
                            if (type === 'admin') this.state.isAdminLoggedIn = true;
                            this.elements.loginModalContainer.innerHTML = '';
                            this.switchView(type);
                        } else { form.querySelector('#login-error').classList.remove('hidden'); }
                    };
                    this.elements.loginModalContainer.querySelector('.cancel-login-btn').onclick = () => { this.elements.loginModalContainer.innerHTML = ''; this.switchView('initial'); };
                },
                showConfirmModal(title, message, onConfirm) {
                     this.elements.genericModalContainer.innerHTML = `<div class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-[10000] p-4"><div class="bg-gray-800 p-8 rounded-xl shadow-2xl w-full max-w-md border border-gray-700"><h2 class="text-2xl font-bold text-white mb-4">${title}</h2><p class="text-gray-300 mb-6">${message}</p><div class="flex justify-end gap-4"><button id="modal-cancel" class="bg-gray-600 hover:bg-gray-500 text-white font-bold py-2 px-6 rounded-lg">Cancel</button><button id="modal-confirm" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-6 rounded-lg">Confirm</button></div></div></div>`;
                    document.getElementById('modal-cancel').onclick = () => this.elements.genericModalContainer.innerHTML = '';
                    document.getElementById('modal-confirm').onclick = () => { onConfirm(); this.elements.genericModalContainer.innerHTML = ''; };
                },
                showPromptModal(title, placeholder, onSubmit) {
                     this.elements.genericModalContainer.innerHTML = `<div class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-[10000] p-4"><form id="prompt-form" class="bg-gray-800 p-8 rounded-xl shadow-2xl w-full max-w-md border border-gray-700"><h2 class="text-2xl font-bold text-white mb-4">${title}</h2><input type="text" id="modal-input" class="w-full p-3 bg-gray-900 border border-gray-600 rounded-lg mb-6" placeholder="${placeholder}"><div class="flex justify-end gap-4"><button type="button" id="modal-cancel" class="bg-gray-600 hover:bg-gray-500 text-white font-bold py-2 px-6 rounded-lg">Cancel</button><button type="submit" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-6 rounded-lg">Submit</button></div></form></div>`;
                    const input = document.getElementById('modal-input');
                    input.focus();
                    document.getElementById('modal-cancel').onclick = () => this.elements.genericModalContainer.innerHTML = '';
                    document.getElementById('prompt-form').onsubmit = (e) => { e.preventDefault(); onSubmit(input.value); this.elements.genericModalContainer.innerHTML = ''; };
                },
                showInfoModal(title, content) {
                     this.elements.genericModalContainer.innerHTML = `<div class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-[10000] p-4"><div class="bg-gray-800 p-8 rounded-xl shadow-2xl w-full max-w-lg border border-gray-700 max-h-[80vh] overflow-y-auto"><h2 class="text-2xl font-bold text-white mb-4">${title}</h2><div class="text-gray-300 mb-6 space-y-2">${content}</div><div class="flex justify-end"><button id="modal-close" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-6 rounded-lg">Close</button></div></div></div>`;
                    document.getElementById('modal-close').onclick = () => this.elements.genericModalContainer.innerHTML = '';
                },
                showImageModal(src) {
                     this.elements.genericModalContainer.innerHTML = `<div class="fixed inset-0 bg-black bg-opacity-90 flex items-center justify-center z-[10000] p-4" id="image-modal-backdrop"><img src="${src}" class="max-w-full max-h-full object-contain"></div>`;
                     document.getElementById('image-modal-backdrop').onclick = () => this.elements.genericModalContainer.innerHTML = '';
                },
                validateLink(link) { return link && (link.startsWith('http://') || link.startsWith('https://')); },
                copyToClipboard(text, message = "Copied to clipboard!") {
                    if (!navigator.clipboard) { this.showNotification("Clipboard not supported.", 'error'); return; }
                    navigator.clipboard.writeText(text).then(() => { this.showNotification(message); }, () => { this.showNotification("Failed to copy.", 'error'); });
                },
                showNotification(message, type = 'success') {
                    const el = this.elements.notification;
                    el.textContent = message;
                    el.className = `notification-toast fixed bottom-5 right-5 text-white py-3 px-5 rounded-lg shadow-xl z-[10001] ${type === 'info' ? 'bg-blue-600' : type === 'success' ? 'bg-green-600' : 'bg-red-600'}`;
                    setTimeout(() => el.classList.add('hidden'), 4000);
                }
            };

            app.init();
        });
    </script>
</body>
</html>
